# 第一课 引论与实例



## 操作系统应有的特点或者说是基本的功能

1. 对软件和硬件的抽象
2. 硬件的复用（例如键盘这个硬件，应该能被各种软件使用，）
3. 隔离性，保证软件和软件之间不会相互影响，即使一个软件崩溃，也不能影响到其他软件
4. 分享性，一个用户的资料可以分享给其他的用户（这个特性主要针的情形是多个用户在一台设备上以不同的账号使用同一个操作系统，在上古时代一台主机可能要同时供给多个人使用，大家可以用不同的账号同时登陆同一台主机，当然这种情形对当今的普通用户而言并不是很常见...）
5. 权限控制 或者说 安全性，不想给你分享文件的时候就不分享
6. 高性能
7. 能运行各种软件的能力
8. 足够灵活，给用户足够的自由，但是也必须得保证硬件安全



## 操作系统的典型架构

### 用户-内核-硬件架构

最常见的结构如下：

user space -> kernel -> hard ware

例如： 运行在用户空间的文本编辑器软件(vim)，需要借由内核中的(文件系统)，去访问存储在硬盘(disk)中的文件；

大多数软件都遵循上述的工作逻辑，但是大多数软件的逻辑都会更加复杂；

接下来（整个笔记）的内容基本上都是对第二部分 kernel 的讲解

从未接触过这个话题的同学可能会问什么是内核；首先，内核也是一段代码，相较于普通程序，内核是一段始终驻留在操作系统中的代码，并且这段代码拥有特殊的权限，它可以直接访问/操作硬件；这种权限普通的代码是不能有的，否则用户就可以轻而易举的毁掉自己的电脑...



### 内核API

解释一下什么叫做内核API，虽然这个名词听起来非常的高端，但实际上它只是一个特殊的函数，例如：

```c
fd = open("a.txt",1)
```

这是一个内核调用，看起来它只是一个普通的函数，但是执行的时候，操作系统会跳转到内核执行一系列操作，帮你打开这个叫做"a.txt"的文件，这个过程势必需要硬件参与，因为文件一定是需要从硬盘中被读出来的；但凡是这一类需要与硬件交互的功能，最后都一定会有一个内核API去完成实质性的工作；这样设计就是为了防止你毁掉自己的硬件设备；



--------------------

上面的东西如果看不懂，那么我建议是先阅读一些通识性的书籍，例如 《程序员的自我修养：链接、装载与库 (俞甲子,石凡,潘爱民) 》，这本书会告诉你，从一个文本文件到可以执行的代码，再到屏幕上输出的字符，这中间到底经过了什么流程，到底发生了什么事情；

 

## 关于lab

https://pdos.csail.mit.edu/6.828/2020/tools.html

在这个网站上有lab相关的信息，lab就像一个课后作业；



## 正式开始

### 环境搭建

详细过程请参照：https://pdos.csail.mit.edu/6.828/2020/tools.html

接下来是我的安装过程：

这门课程使用的教学用操作系统叫做xv6，这个操作系统是由Unix version 6精简来的，当然在2024年这个档口Unix几乎已经快要退出历史舞台了，但不可否认的是它对linux甚至windows都有很深刻的影响，其设计哲学对整个计算机世界的影响非常大，运行在risc-v架构上，所以我们需要安装一个虚拟risc-v的环境；我选择在WSL上运行，linux版本选择了ubuntu22.04LTS

```shell
lifugui@lifugui_thinkpa:~$ sudo apt-get install git build-essential gdb-multiarch qemu-system-misc gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu
# 这里建议使用20.00版本后的ubuntu，从网上的资料老看有一些较老版本的ubuntu的源里缺少软件包；
# 如果出现了找不到包的情况，可以先sudo apt-get update一下
# 安装完成之后检测一下
lifugui@lifugui_thinkpa:~$ qemu-system-riscv64 --version
QEMU emulator version 6.2.0 (Debian 1:6.2+dfsg-2ubuntu6.16)
Copyright (c) 2003-2021 Fabrice Bellard and the QEMU Project developers

lifugui@lifugui_thinkpa:~$ riscv64-unknown-elf-gcc --version
riscv64-unknown-elf-gcc () 10.2.0
Copyright (C) 2020 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

# 顺带一提..我这里的 riscv64-unknown-elf-gcc 是后来用apt install装上的..不知为何按照官网上的脚本执行之后没有这个 riscv64-unknown-elf-gcc=，不过倒是有riscv64的linux编译工具...很怪
```

然后克隆xv6的代码

```shell
git clone git://github.com/mit-pdos/xv6-riscv.git
git clone git://github.com/mit-pdos/xv6-riscv-book.git
```

...这一步真难搞...国内访问github真是令人痛苦....我的建议是科学上网...

then，要进行编译

```shell
# 进入xv6-riscv文件夹，执行make
lifugui@lifugui_thinkpa:/mnt/d/6s081/xv6-riscv$ make
# 然后使用qemu启动xv6
lifugui@lifugui_thinkpa:/mnt/d/6s081/xv6-riscv$ make qemu
# 如果成功的话，会输出
xv6 kernel is booting

hart 2 starting
hart 1 starting
init: starting sh
# now，你已经进入了xv6这个系统
# 如果你想退出这个系统，可以按ctrl+a，然后按x
```



### riscv gdb

如果不知道gdb有什么用，那就先别装了，后续的文章里我会展示这个东西的作用，到时候再装也不迟

折磨了我很长时间....不知道为啥我通过apt-get安装的 toolchain 没有riscv的gdb，我用了三天时间才装上...参考下面这个知乎连接

https://zhuanlan.zhihu.com/p/638731320



```shell
# 安装相关依赖
sudo apt-get install libncurses5-dev python2 python2-dev texinfo libreadline-dev
# 从清华大学开源镜像站下载gdb源码(约23MB)
wget https://mirrors.tuna.tsinghua.edu.cn/gnu/gdb/gdb-13.1.tar.xz
# 解压gdb源码压缩包
tar -xvf gdb-13.1.tar.xz
# 进入gdb源码目录
cd gdb-13.1
mkdir build && cd build
# 配置编译选项，这里只编译riscv64-unknown-elf一个目标文件
../configure --prefix=/usr/local --target=riscv64-unknown-elf --enable-tui=yes
# 在上面一行编译配置选项中，很多其他的文章会配置一个python选项
# 但我在尝试中发现配置了python选项后后面的编译过程会报错，不添加python选项则没有问题

# 开始编译，这里编译可能消耗较长时间，具体时长取决于机器性能
make -j$(nproc)
# 编译完成后进行安装
sudo make install
```



```shell
# 启动gdb发现还是不行
To enable execution of this file add
        add-auto-load-safe-path /mnt/d/6s081/xv6-riscv/.gdbinit
line to your configuration file "/home/lifugui/.gdbinit".lifugui@lifugui_thinkpa:/mnt/d/6s081/xv6-riscv$ riscv64-unknown-elf-gdb
GNU gdb (GDB) 13.1
Copyright (C) 2023 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "--host=x86_64-pc-linux-gnu --target=riscv64-unknown-elf".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word".
warning: File "/mnt/d/6s081/xv6-riscv/.gdbinit" auto-loading has been declined by your `auto-load safe-path' set to "$debugdir:$datadir/auto-load:/home/username/.gdbinit".
To enable execution of this file add
        add-auto-load-safe-path /mnt/d/6s081/xv6-riscv/.gdbinit
line to your configuration file "/home/lifugui/.gdbinit".
To completely disable this security protection add
        set auto-load safe-path /
line to your configuration file "/home/lifugui/.gdbinit".
For more information about this security protection see the
"Auto-loading safe path" section in the GDB manual.  E.g., run from the shell:
        info "(gdb)Auto-loading safe path"
(gdb) q

# 按照它的提示
lifugui@lifugui_thinkpa:/mnt/d/6s081/xv6-riscv$ touch /home/lifugui/.gdbinit
lifugui@lifugui_thinkpa:/mnt/d/6s081/xv6-riscv$ echo  add-auto-load-safe-path /mnt/d/6s081/xv6-riscv/.gdbinit > /home/lifugui/.gdbinit

# 然后就可以了
```





## 例子

第一课中举了很多关于系统调用的例子，比如，输出（write），子进程的创建(fork)，如果您之前从未了解过这些概念，建议看一下原视频，对这些概念建立一些基本的认知；

























